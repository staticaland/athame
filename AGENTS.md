# Dagger Development Guidelines

## Monorepo Structure

This is a Dagger monorepo where we create and manage multiple Dagger modules, always using the Go SDK.

### Creating New Modules

To create a new module, use:

```bash
dagger init --sdk=go --name=<module-name>
```

Example:
```bash
dagger init --sdk=go --name=basics
```

Command format: `dagger init [options] [path]`

### Using Modules

To use a module in your project, use the `dagger install` command:

```bash
dagger install [options] <module>
```

### Directory Structure

- **`.dagger/`** - Optional orchestration module. Use `dagger install` here to compose multiple modules, or create dedicated wrapper modules elsewhere. Project CI may also live here.
- **Individual module directories** - Each module lives in its own directory at the repo root.

## Import Path

Always import Dagger from:
```go
import "dagger/<module-name>/internal/dagger"
```

Replace `<module-name>` with your actual module name.

## Generated Files - Do Not Edit

These files are auto-generated by Dagger and should never be manually edited:

- `dagger.gen.go`
- `internal/` directory

## Function Parameters

Use Dagger annotations for parameter handling:

- `+default="value"` - for parameters with default values
- `+optional` - for parameters that can be omitted

### Required Patterns

- **Use annotations exclusively** - let Dagger handle defaults, not your function body
- **Trust the framework** - write functions assuming defaults are already applied
- **Document well** - add descriptive comments for optional parameters

### Forbidden Patterns

- **No manual checks** - don't use `if param == ""` for parameters with `+default` annotations
- **No defensive logic** - avoid conditional logic for optional parameters unless your business logic requires it
- **No mixing approaches** - don't combine annotations with manual default handling

## Example

```go
// Deploy runs the deployment process
// +optional
func (m *MyModule) Deploy(
    // +default="production"
    environment string,
    // +optional
    dryRun bool,
) error {
    // Function body assumes defaults are already applied
    // No need for: if environment == "" { environment = "production" }
}
```

## Claude Skills

### Crane Image Finder

Use the **crane** Claude skill (`.claude/skills/crane.md`) when working with container images. This skill helps you:

- Find available container image tags using `crane ls`
- Add proper Renovate regex patterns for automated dependency updates
- Follow best practices for container image management

**When to use**: Anytime you're adding or updating container images in Dockerfiles, YAML configurations, or any files that reference container images.

**Key requirement**: Always include Renovate regex strings when working with container images to enable automated dependency updates.

Example pattern:
```dockerfile
# renovate: datasource=docker depName=golang
ARG GO_VERSION=1.21.0
FROM golang:${GO_VERSION}
```
